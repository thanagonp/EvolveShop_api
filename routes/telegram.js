import express from 'express';
import axios from 'axios';
import Product from '../models/Product.js';

const router = express.Router();

const TELEGRAM_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const TOGETHER_API_KEY = process.env.TOGETHER_API_KEY;
const TELEGRAM_API = `https://api.telegram.org/bot${TELEGRAM_TOKEN}`;
const TOGETHER_API = "https://api.together.xyz/v1/chat/completions";

// р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕Кр╣Ир╕зр╕вр╕Бр╕гр╕нр╕Зр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Хр╕▓р╕б keyword р╣Ар╕Ър╕╖р╣Йр╕нр╕Зр╕Хр╣Йр╕Щ
const filterProducts = (products, userText) => {
  const keywords = ['р╕Др╕нр╕Бр╕ер╕б', 'р╣Ар╕кр╕╖р╣Йр╕нр╕вр╕╖р╕Ф', 'р╣Ар╕Кр╕┤р╣Йр╕Х', 'р╣Ар╕Фр╕гр╕к', 'р╕Ьр╕╣р╣Йр╕лр╕Нр╕┤р╕З', 'р╕Ьр╕╣р╣Йр╕Кр╕▓р╕в', 'р╣Ар╕Чр╕╡р╣Ир╕вр╕з'];
  const lowerText = userText.toLowerCase();
  return products.filter(p =>
    keywords.some(k => lowerText.includes(k)) &&
    (p.name.toLowerCase().includes(lowerText) || p.description.toLowerCase().includes(lowerText))
  );
};

router.post('/telegram', async (req, res) => {
  const message = req.body.message;
  if (!message || !message.text) return res.sendStatus(200);

  const chatId = message.chat.id;
  const userText = message.text;

  try {
    const allProducts = await Product.find({ status: 'available' });

    // р╕Бр╕гр╕нр╕Зр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Хр╕▓р╕бр╕Др╕│р╕Цр╕▓р╕бр╕Вр╕нр╕Зр╕ер╕╣р╕Бр╕Др╣Йр╕▓р╣Бр╕Ър╕Ър╣Ар╕Ър╕╖р╣Йр╕нр╕Зр╕Хр╣Йр╕Щ
    const matchedProducts = filterProducts(allProducts, userText);
    const productsToShow = matchedProducts.slice(0, 5);

    const productDetailsList = productsToShow.map(p => {
      return `
ЁЯФЦ р╕Кр╕╖р╣Ир╕нр╕кр╕┤р╕Щр╕Др╣Йр╕▓: ${p.name}
ЁЯТ░ р╕гр╕▓р╕Др╕▓: ${p.price} р╕Ър╕▓р╕Ч
ЁЯУж р╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н: ${p.stock} р╕Кр╕┤р╣Йр╕Щ
ЁЯОи р╕кр╕╡: ${p.color?.[0] || 'р╣Др╕бр╣Ир╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕е'}
ЁЯУП р╣Др╕Лр╕кр╣М: ${p.size?.[0] || 'р╣Др╕бр╣Ир╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕е'}
ЁЯУЭ р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Ф: ${p.description || 'р╣Др╕бр╣Ир╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕е'}
ЁЯМР р╕Фр╕╣р╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕б: https://evolve-shop.vercel.app/`;
    }).join('\n\n');

    // р╣Бр╕Ир╣Йр╕Зр╕Ир╕│р╕Щр╕зр╕Щр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Чр╕╡р╣Ир╕вр╕▒р╕Зр╣Др╕бр╣Ир╣Др╕Фр╣Йр╣Бр╕кр╕Фр╕З
    const remainingCount = matchedProducts.length - productsToShow.length;
    const note = remainingCount > 0
      ? `\n\nЁЯФО р╕вр╕▒р╕Зр╕бр╕╡р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕нр╕╡р╕Б ${remainingCount} р╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Чр╕╡р╣Ир╣Ар╕Бр╕╡р╣Ир╕вр╕зр╕Вр╣Йр╕нр╕З р╕лр╕▓р╕Бр╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕Фр╕╣р╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕б р╣Вр╕Ыр╕гр╕Фр╣Ар╕Вр╣Йр╕▓р╣Ар╕зр╣Зр╕Ър╣Др╕Лр╕Хр╣Мр╕Вр╕нр╕Зр╣Ар╕гр╕▓: https://evolve-shop.vercel.app/`
      : '';

      const systemPrompt = `
      р╕Др╕╕р╕Ур╕Др╕╖р╕нр╣Бр╕нр╕Фр╕бр╕┤р╕Щр╕Вр╕нр╕Зр╕гр╣Йр╕▓р╕Щр╕Др╣Йр╕▓р╕нр╕нр╕Щр╣Др╕ер╕Щр╣Мр╕Кр╕╖р╣Ир╕н "Evolve Shop" р╕Чр╕│р╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣Ир╕Хр╕нр╕Ър╕Др╕│р╕Цр╕▓р╕бр╣Ар╕Бр╕╡р╣Ир╕вр╕зр╕Бр╕▒р╕Ър╕кр╕┤р╕Щр╕Др╣Йр╕▓р╣Ар╕кр╕╖р╣Йр╕нр╕Ьр╣Йр╕▓р╣Гр╕лр╣Йр╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕нр╕вр╣Ир╕▓р╕Зр╕кр╕╕р╕ар╕▓р╕Юр╣Бр╕ер╕░р╣Бр╕бр╣Ир╕Щр╕вр╕│
      
      ЁЯФР р╕Бр╕Ор╕кр╕│р╕Др╕▒р╕Нр╣Гр╕Щр╕Бр╕▓р╕гр╕Хр╕нр╕Ъ:
      - р╕лр╣Йр╕▓р╕бр╕кр╕гр╣Йр╕▓р╕Зр╕лр╕гр╕╖р╕нр╣Ар╕Фр╕▓р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕╡р╣Ир╣Др╕бр╣Ир╕бр╕╡р╕нр╕вр╕╣р╣Ир╕Ир╕гр╕┤р╕Зр╣Ар╕Фр╣Зр╕Фр╕Вр╕▓р╕Ф
      - р╣Гр╕лр╣Йр╕Хр╕нр╕Ър╣Ар╕Йр╕Юр╕▓р╕░р╕Ир╕▓р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕гр╕▓р╕вр╕Бр╕▓р╕гр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Чр╕╡р╣Ир╣Бр╕кр╕Фр╕Зр╣Др╕зр╣Йр╕Фр╣Йр╕▓р╕Щр╕ер╣Ир╕▓р╕Зр╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ
      - р╕Цр╣Йр╕▓р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╣Др╕бр╣Ир╕Хр╕гр╕Зр╕Бр╕▒р╕Ър╕Др╕│р╕Цр╕▓р╕б р╣Гр╕лр╣Йр╕Ър╕нр╕Бр╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕зр╣Ир╕▓ тАЬр╣Др╕бр╣Ир╕бр╕╡р╕кр╕┤р╕Щр╕Др╣Йр╕▓тАЭ р╕лр╕гр╕╖р╕нр╣Бр╕Щр╕░р╕Щр╕│р╣Гр╕лр╣Йр╕Фр╕╣р╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕бр╕Чр╕╡р╣Ир╣Ар╕зр╣Зр╕Ър╣Др╕Лр╕Хр╣М
      - р╕лр╣Йр╕▓р╕бр╕кр╕гр╕╕р╕Ыр╕зр╣Ир╕▓р╕бр╕╡р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╣Гр╕Щр╕кр╕╡р╕лр╕гр╕╖р╕нр╣Др╕Лр╕кр╣Мр╣Гр╕Фр╣Ж р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕бр╕╡р╣Гр╕Щр╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Фр╣Йр╕▓р╕Щр╕ер╣Ир╕▓р╕З
      - р╕лр╣Йр╕▓р╕бр╣Гр╕Кр╣Йр╕ар╕▓р╕йр╕▓р╕Др╕ер╕╕р╕бр╣Ар╕Др╕гр╕╖р╕н р╣Ар╕Кр╣Ир╕Щ тАЬр╕Щр╣Ир╕▓р╕Ир╕░р╕бр╕╡тАЭ, тАЬр╕нр╕▓р╕Ир╕Ир╕░р╕бр╕╡тАЭ р╕лр╕гр╕╖р╕н тАЬр╕бр╕╡р╕лр╕ер╕▓р╕вр╕кр╕╡тАЭ
      
      ЁЯУМ р╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕нр╕▓р╕Ир╕Цр╕▓р╕бр╕Цр╕╢р╕З:
      - р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Чр╕╡р╣Ир╕бр╕╡р╕кр╕╡р╕лр╕гр╕╖р╕нр╣Др╕Лр╕кр╣Мр╣Ар╕Йр╕Юр╕▓р╕░
      - р╕гр╕▓р╕Др╕▓р╕Ыр╕гр╕░р╕бр╕▓р╕Ур╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕г
      - р╕Ыр╕гр╕░р╣Ар╕ар╕Чр╣Ар╕кр╕╖р╣Йр╕нр╕Ьр╣Йр╕▓ р╣Ар╕Кр╣Ир╕Щ р╣Ар╕кр╕╖р╣Йр╕нр╕Др╕нр╕Бр╕ер╕б, р╣Ар╕кр╕╖р╣Йр╕нр╣Ар╕Кр╕┤р╣Йр╕Х, р╣Ар╕кр╕╖р╣Йр╕нр╣Гр╕кр╣Ир╣Ар╕Чр╕╡р╣Ир╕вр╕з
      - р╕Др╕│р╣Бр╕Щр╕░р╕Щр╕│р╣Ар╕гр╕╖р╣Ир╕нр╕Зр╕кр╣Др╕Хр╕ер╣М р╕лр╕гр╕╖р╕нр╣Др╕Лр╕кр╣Мр╕Чр╕╡р╣Ир╣Ар╕лр╕бр╕▓р╕░р╕кр╕б
      
      ЁЯУж р╕гр╕▓р╕вр╕Бр╕▓р╕гр╕кр╕┤р╕Щр╕Др╣Йр╕▓:
      ${productDetailsList}${note}
      
      ЁЯУЭ р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕:
      р╕лр╕▓р╕Бр╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕Фр╕╣р╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕б р╣Гр╕лр╣Йр╣Бр╕Щр╕░р╕Щр╕│р╣Гр╕лр╣Йр╣Др╕Ыр╕Чр╕╡р╣Ир╣Ар╕зр╣Зр╕Ър╣Др╕Лр╕Хр╣М: https://evolve-shop.vercel.app/
      `;
    const messages = [
      { role: "system", content: systemPrompt },
      { role: "user", content: userText }
    ];

    const aiResponse = await axios.post(TOGETHER_API, {
      model: "meta-llama/Llama-Vision-Free",
      messages,
      temperature: 0.4
    }, {
      headers: {
        Authorization: `Bearer ${TOGETHER_API_KEY}`,
        "Content-Type": "application/json"
      }
    });

    let aiReply = aiResponse.data.choices[0].message.content.trim();
    if (!aiReply) {
      aiReply = 'р╕Вр╕нр╕нр╕ар╕▒р╕вр╕Др╣Ир╕░ р╕Хр╕нр╕Щр╕Щр╕╡р╣Йр╕гр╕░р╕Ър╕Ър╕бр╕╡р╕Ыр╕▒р╕Нр╕лр╕▓р╣Гр╕Щр╕Бр╕▓р╕гр╕Хр╕нр╕Ър╕Бр╕ер╕▒р╕Ъ р╣Вр╕Ыр╕гр╕Фр╕Хр╕┤р╕Фр╕Хр╣Ир╕нр╣Бр╕нр╕Фр╕бр╕┤р╕Щр╣Вр╕Фр╕вр╕Хр╕гр╕З';
    }

    await axios.post(`${TELEGRAM_API}/sendMessage`, {
      chat_id: chatId,
      text: aiReply
    });

    res.sendStatus(200);
  } catch (err) {
    console.error(err.response?.data || err.message);
    res.sendStatus(500);
  }
});

export default router;
